<template lang="pug">
  div
    .main_title.main_title__content
      | My story
    .md-card__list
      transition-group(
        appear
      )
        md-card(
          v-for="item in stories"
          :key="item.no"
        )
          .md_card
            md-card-header
              md-card-header-text
                .md-title
                  | {{ item.season_end.split("T")[0] }}
                  | ã€œ
                  | {{ item.season_start.split("T")[0] }}
                .md-subhead.japanese-font
                  | {{ item.product_name }}
                div(style="margin-top: 2%")
                  md-icon(style="margin: 2px") build
                  | Tech
                  md-icon(style="margin: 2px") build
                  multi-tag(
                    :tags="item.language.split('\\n')"
                  )
                div(style="margin-top: 2%")
                  md-icon(style="margin: 2px") work
                  | Tools
                  md-icon(style="margin: 2px") work
                  multi-tag(
                  :tags="item.tools.split('\\n')"
                  )
            .img_space
              img.imgFix(
                v-if="item.image_url"
                :src="item.image_url"
              )
              img.imgFix(
                v-if="item.image_url2"
                :src="item.image_url2"
              )
            .button_space
              md-button(
                style="margin-bottom: 3%"
                class="md-raised"
                @click="onClickShowDetail(item.no)"
              ) Detail
    story-detail(
      v-if="isShow"
      :story="story"
      :is-show="isShow"
    )
</template>

<script>
import CsvDialog from './CsvDialog'
import MultiTag from './MultiTag'
import StoryDetail from './StoryDetail'
import firebase from 'firebase'

export default {
  name: 'Story',
  data () {
    return {
      stories: [],
      story: null,
      isShow: false,
      url: 'https://script.google.com/macros/s/AKfycbwoDWgY7IDhIKYGsy6afqCM-lhcPvDcVUAaxMrh6p8DSoqTPQ/exec'
    }
  },
  created () {
    this.getStoriesByFirebase()
    this.$eventHub.$on('update-is-show', this.updateIsShow)
  },
  beforeDestroy () {
    this.$eventHub.$off('update-is-show', this.updateIsShow)
  },
  components: {
    CsvDialog,
    MultiTag,
    StoryDetail
  },
  methods: {
    // getStoriesByGas () {
    //   axios
    //     .get(this.url)
    //     .then(res => {
    //       this.stories = res.data.filter(v => v.no !== '').sort((a, b) => a.no < b.no ? 1 : -1)
    //     }).catch(err => {
    //       console.log(err)
    //     })
    // },
    getStoriesByFirebase () {
      const _this = this
      firebase.database().ref('stories').on('value', function (snapshot) {
        _this.stories = snapshot.val()
          .filter(v => v.no !== '')
          .sort((a, b) => a.no < b.no ? 1 : -1)
      })
    },
    onClickShowDetail (no) {
      this.story = this.stories.filter(v => v.no === no)[0]
      this.isShow = true
    },
    updateIsShow (isShow) {
      this.isShow = isShow
    }
  }
}
</script>

<style lang="sass" scoped>
  .md-card__list
    padding: 0

  .md-card
    display: inline-block
    vertical-align: top

  @media screen and (min-width: 961px)
    .md-card
      margin: 0 1% 2% 1%
      width: 25%
      max-height: 35.0em
      height: 33em

  @media screen and (max-width: 375px)
    .md-card
      margin: 0 4% 2% 4%
      width: 92%

  .flex
    display: flex

  .imgFix
    width: 30%
    padding: 2%

  .v-enter-active
    transition: all .2s ease

  .v-leave-active
    transition: all .2s

  .v-enter, .v-leave-to
    transform: translateX(10px)
    opacity: 0
</style>
